<!-- START OF FILE painel.html -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - NIO PESQUISA</title>
    
    <link rel="shortcut icon" href="img/favicon1.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/estilo.css">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    
    <style>
        /* --- ESTILOS EXCLUSIVOS DO PAINEL --- */
        .navbar-top-modern {
            background-color: var(--azul);
            padding: 12px 20px;
        }
        .nav-link-custom {
            color: rgba(255,255,255,0.7) !important;
            font-weight: 600;
            padding: 8px 18px !important;
            border-radius: 8px;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        .nav-link-custom:hover {
            color: white !important;
            background: rgba(255,255,255,0.1);
        }
        .nav-link-custom.active {
            color: white !important;
            background: rgba(255,255,255,0.2);
            box-shadow: inset 0 -2px 0 #ffc107;
        }

        .card-resumo {
            position: relative;
            padding: 25px 20px;
            border-radius: 15px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            overflow: hidden;
            border: none;
            transition: transform 0.3s ease;
            cursor: pointer;
            min-height: 135px;
        }
        .card-resumo:hover { transform: translateY(-5px); }
        .kpi-label { display: block; text-transform: uppercase; font-size: 0.75rem; font-weight: 800; letter-spacing: 1px; margin-bottom: 5px; opacity: 0.9; }
        .kpi-value { font-size: 3.2rem; font-weight: 900; margin: 0; line-height: 1; }
        .kpi-icon { font-size: 4rem; position: absolute; right: -10px; bottom: -15px; opacity: 0.2; transform: rotate(-15deg); }

        .bg-pendente { background: linear-gradient(45deg, #f1b44c, #f19f00); }
        .bg-atendido { background: linear-gradient(45deg, #34c38f, #2ca073); }
        .bg-nao-encontrado { background: linear-gradient(45deg, #f46a6a, #d64545); }
        .bg-total { background: linear-gradient(45deg, #556ee6, #3b5de7); }

        .form-control:disabled { background-color: #f8f9fa; color: #6c757d; cursor: not-allowed; border-style: dashed; }

        @media (min-width: 993px) { 
            .navbar-menu-center { position: absolute; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; } 
        }
        @media (max-width: 992px) {
            .navbar-menu-center { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 15px 0; width: 100%; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
            .table thead { display: none; }
            .table tr { display: block; margin-bottom: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee; }
            .table td { display: flex; justify-content: space-between; align-items: center; text-align: right; border-bottom: 1px solid #f0f0f0; padding: 10px 15px; }
            .table td::before { content: attr(data-label); font-weight: bold; color: #666; text-transform: uppercase; font-size: 0.75rem; text-align: left; }
        }
    </style>
</head>
<body class="bg-light">

    <!-- NAVBAR NIO PESQUISA -->
    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm sticky-top navbar-top-modern">
        <div class="container-fluid px-lg-5">
            <span class="navbar-brand fw-bold fs-4">
                <i class="bi bi-shield-lock-fill me-2 text-warning"></i>NIO <span class="fw-light opacity-75">PESQUISA</span>
            </span>
            
            <div class="navbar-menu-center">
                <a class="nav-link-custom active" href="painel.html"><i class="bi bi-list-task"></i> Pedidos</a>
                <a class="nav-link-custom" href="referencias.html"><i class="bi bi-book"></i> Refer√™ncias</a>
                <a class="nav-link-custom" href="relatorios.html"><i class="bi bi-graph-up-arrow"></i> Relat√≥rios</a>
            </div>

            <div class="d-flex align-items-center text-white ms-auto">
                <span class="me-3 d-none d-sm-inline opacity-75 small">Ol√°, <strong id="nomeUsuario">...</strong></span>
                <button onclick="sair()" class="btn btn-sm btn-outline-light rounded-pill px-3 fw-bold">SAIR</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4 px-lg-5">
        <div class="d-flex justify-content-between align-items-end mb-4">
            <div><h2 class="fw-bold text-dark m-0">Gest√£o de Pedidos</h2><small class="text-muted"><i class="bi bi-circle-fill text-success small me-1"></i> Atualiza√ß√£o autom√°tica ativa</small></div>
            <button class="btn btn-success fw-bold shadow-sm px-4 py-2 rounded-3" onclick="abrirModalNovo()">+ NOVO PEDIDO</button>
        </div>

        <!-- CARDS KPI -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3"><div class="card-resumo bg-pendente shadow-sm" onclick="filtrarPorCard('EM AN√ÅLISE')"><div><span class="kpi-label">Pendentes</span><h2 class="kpi-value" id="totalAnalise">0</h2></div><i class="bi bi-hourglass-split kpi-icon"></i></div></div>
            <div class="col-6 col-md-3"><div class="card-resumo bg-atendido shadow-sm" onclick="filtrarPorCard('ATENDIDO')"><div><span class="kpi-label">Atendidos</span><h2 class="kpi-value" id="totalAtendidos">0</h2></div><i class="bi bi-check-circle kpi-icon"></i></div></div>
            <div class="col-6 col-md-3"><div class="card-resumo bg-nao-encontrado shadow-sm" onclick="filtrarPorCard('N√ÉO ENCONTRADO')"><div><span class="kpi-label">N√£o Enc.</span><h2 class="kpi-value" id="totalNaoEnc">0</h2></div><i class="bi bi-x-circle kpi-icon"></i></div></div>
            <div class="col-6 col-md-3"><div class="card-resumo bg-total shadow-sm" onclick="filtrarPorCard('TODOS')"><div><span class="kpi-label">Total Geral</span><h2 class="kpi-value" id="totalPedidos">0</h2></div><i class="bi bi-grid-fill kpi-icon"></i></div></div>
        </div>

        <div class="card shadow-sm border-0 mb-4 rounded-3"><div class="card-body p-3"><div class="row g-2 align-items-center"><div class="col-12 col-md"><div class="input-group"><span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span><input type="text" id="inputPesquisa" class="form-control border-start-0 bg-light" placeholder="Buscar..." onkeyup="aplicarFiltros()"></div></div><div class="col-8 col-md-auto"><select id="filtroStatus" class="form-select border-0 bg-light fw-bold" onchange="aplicarFiltros()"><option value="EM AN√ÅLISE" selected>‚ö†Ô∏è PENDENTES</option><option value="TODOS">üìã TODOS</option><option value="ATENDIDO">‚úÖ ATENDIDOS</option><option value="N√ÉO ENCONTRADO">‚ùå N√ÉO ENC.</option></select></div><div class="col-4 col-md-auto"><button onclick="carregarPedidos()" class="btn btn-primary w-100 fw-bold">ATUALIZAR</button></div></div></div></div>

        <div class="table-responsive bg-white shadow-sm rounded-3">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light text-uppercase small fw-bold"><tr><th class="ps-4">Data</th><th>Solicitante</th><th style="width: 25%;">Nome Pesquisado</th><th>Per√≠odo</th><th>Contato</th><th>Status</th><th>Resp.</th><th class="text-end pe-4">A√ß√£o</th></tr></thead>
                <tbody id="tabelaPedidos"></tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-3"><span class="text-muted small">P√°gina <span id="paginaAtual" class="fw-bold text-primary">1</span></span><div class="btn-group shadow-sm"><button class="btn btn-white btn-sm border" onclick="mudarPagina(-1)">Anterior</button><button class="btn btn-white btn-sm border" onclick="mudarPagina(1)">Pr√≥xima</button></div></div>
    </div>

    <!-- MODAL DETALHES / ATENDIMENTO -->
    <div class="modal fade" id="modalAtendimento" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold" id="modalTitulo">Atendimento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="editId">
                    <div class="mb-3 p-3 bg-light rounded border small">
                        <strong>Solicitante:</strong> <span id="viewNome"></span><br>
                        <strong>WhatsApp:</strong> <span id="viewZap"></span><br>
                        <strong>Nome Pesquisado:</strong> <span id="viewOque"></span><br>
                        <strong>Obs. do Cidad√£o:</strong> <span id="viewObsOrig" class="text-muted"></span>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold small text-muted mb-2">STATUS ATUAL:</label>
                        <select id="editStatus" class="form-select fw-bold border-primary">
                            <option value="EM AN√ÅLISE">‚ö†Ô∏è EM AN√ÅLISE</option>
                            <option value="ATENDIDO">‚úÖ PEDIDO ATENDIDO</option>
                            <option value="N√ÉO ENCONTRADO">‚ùå N√ÉO ENCONTRADO</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="fw-bold small text-muted">RETORNO / RESPOSTA AO CIDAD√ÉO:</label>
                            <button class="btn btn-sm btn-outline-primary border-0" onclick="$('#editRetorno').prop('disabled', false).focus();"><i class="bi bi-pencil-square"></i></button>
                        </div>
                        <textarea id="editRetorno" class="form-control" rows="5" disabled></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary px-5 fw-bold" id="btnSalvarModal" onclick="salvarAlteracao()">Atualizar Dados</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL NOVO PEDIDO (AJUSTADO) -->
    <div class="modal fade" id="modalNovoPedido" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-success text-white border-0">
                    <h5 class="modal-title fw-bold">Novo Registro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formNovoPedido">
                        <div class="mb-3"><label class="fw-bold small text-muted">SOLICITANTE</label><input type="text" id="novoSolicitante" class="form-control" required placeholder="Quem est√° pedindo a busca?"></div>
                        <div class="mb-3"><label class="fw-bold small text-muted">NOME A PESQUISAR</label><input type="text" id="novoPesquisa" class="form-control" required placeholder="Ex: Nome da pessoa, Lei ou Decreto"></div>
                        <div class="row">
                            <div class="col-6 mb-3"><label class="fw-bold small text-muted">ANO / PER√çODO</label><input type="text" id="novoPeriodo" class="form-control" required placeholder="Ex: 1990-1995"></div>
                            <div class="col-6 mb-3"><label class="fw-bold small text-muted">WHATSAPP</label><input type="text" id="novoZap" class="form-control" required placeholder="(96) 00000-0000"></div>
                        </div>
                        <div class="mb-0">
                            <label class="fw-bold small text-muted">DETALHES / OBSERVA√á√ïES DA SOLICITA√á√ÉO</label>
                            <textarea id="novoObs" class="form-control" rows="3" placeholder="Ex: Cliente busca documenta√ß√£o para aposentadoria. Contrato administrativo, professor."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success px-5 fw-bold" onclick="salvarNovoPedido()">Cadastrar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const URL_API = 'https://script.google.com/macros/s/AKfycbwwEI9F6LFkqOqeoF4kKyARouJo-59C-34xhTWfL1bDD538muTldssosywD2G2CYyOpfA/exec';
        let dadosGlobais = [], dadosFiltrados = [], paginaAtual = 1;
        const itensPorPagina = 10;

        // --- L√ìGICA DE FAVICON ANIMADO ---
        let iconIndex = 0;
        const icons = ['img/favicon1.png', 'img/favicon2.png'];
        function changeFavicon() {
            let link = document.querySelector("link[rel~='icon']");
            if (!link) { link = document.createElement('link'); link.rel = 'icon'; document.head.appendChild(link); }
            link.href = icons[iconIndex];
            iconIndex = (iconIndex + 1) % icons.length;
        }
        setInterval(changeFavicon, 3000);

        // --- L√ìGICA DE NOME ---
        const usuarioFull = localStorage.getItem('nio_usuario') || "Servidor";
        if (localStorage.getItem('nio_token') !== 'logado') window.location.href = 'login.html';
        const nFormatado = usuarioFull.split(' ')[0].toLowerCase().replace(/^\w/, c => c.toUpperCase());
        document.getElementById('nomeUsuario').innerText = nFormatado;

        function sair() { localStorage.clear(); window.location.href = 'login.html'; }
        $(document).ready(function(){ $('#novoZap').mask('(00) 00000-0000'); });

        async function carregarPedidos() {
            try {
                const response = await fetch(URL_API + '?acao=listar_pedidos');
                const data = await response.json();
                if (data.result === 'success') {
                    dadosGlobais = data.pedidos.reverse();
                    atualizarContadores(dadosGlobais);
                    aplicarFiltros();
                }
            } catch (e) { }
        }

        function aplicarFiltros() {
            const termo = $('#inputPesquisa').val().toLowerCase();
            const status = $('#filtroStatus').val();
            dadosFiltrados = dadosGlobais.filter(p => (status === 'TODOS' || p[6] === status) && (p[2].toLowerCase().includes(termo) || p[3].toLowerCase().includes(termo)));
            renderizarTabela();
        }

        function renderizarTabela() {
            const tbody = document.getElementById('tabelaPedidos');
            tbody.innerHTML = '';
            const inicio = (paginaAtual - 1) * itensPorPagina;
            const paginaDados = dadosFiltrados.slice(inicio, inicio + itensPorPagina);
            $('#paginaAtual').text(paginaAtual);
            paginaDados.forEach(p => {
                let badge = p[6] === 'ATENDIDO' ? 'bg-success' : (p[6] === 'N√ÉO ENCONTRADO' ? 'bg-danger' : 'bg-warning text-dark');
                let zap = p[5] ? `https://wa.me/55${p[5].replace(/\D/g,'')}` : '#';
                tbody.innerHTML += `<tr><td class="ps-4 small">${p[1]}</td><td class="fw-bold text-primary">${p[2]}</td><td><div class="bg-light p-2 rounded small">${p[3]}</div></td><td>${p[4]}</td><td><a href="${zap}" target="_blank" class="btn btn-sm btn-outline-success border-0 rounded-circle"><i class="bi bi-whatsapp"></i></a></td><td><span class="badge ${badge} rounded-pill">${p[6]}</span></td><td><small>${p[7]||'-'}</small></td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-danger border-0 me-1" onclick="excluirPedido('${p[0]}')"><i class="bi bi-trash"></i></button><button class="btn ${p[6] === 'EM AN√ÅLISE' ? 'btn-primary' : 'btn-outline-secondary'} btn-sm rounded-pill px-3 shadow-sm" onclick="abrirModal('${p[0]}')">${p[6] === 'EM AN√ÅLISE' ? 'Atender' : 'Ver Detalhes'}</button></td></tr>`;
            });
        }

        function abrirModal(id) {
            const p = dadosGlobais.find(item => item[0] === id);
            $('#editId').val(id);
            $('#editStatus').val(p[6]);
            $('#editRetorno').val(p[10] || "").prop('disabled', p[6] !== 'EM AN√ÅLISE');
            $('#viewNome').text(p[2]); $('#viewZap').text(p[5] || 'N√£o informado'); $('#viewOque').text(p[3]); $('#viewObsOrig').text(p[8] || 'Nenhuma');
            modalAtend.show();
        }

        function abrirModalNovo() {
            $('#formNovoPedido')[0].reset();
            const modalNovo = new bootstrap.Modal(document.getElementById('modalNovoPedido'));
            modalNovo.show();
        }

        async function salvarAlteracao() {
            const dados = {acao:'atualizar_pedido', id:$('#editId').val(), status:$('#editStatus').val(), retorno:$('#editRetorno').val(), responsavel:usuarioFull};
            await fetch(URL_API, {method:'POST', mode:'no-cors', body:JSON.stringify(dados)});
            modalAtend.hide(); carregarPedidos();
        }

        async function salvarNovoPedido() {
            const dados = {acao:'novo_pedido', solicitante:$('#novoSolicitante').val(), nome_pesquisado:$('#novoPesquisa').val(), periodo:$('#novoPeriodo').val(), whatsapp:$('#novoZap').val(), observacoes:$('#novoObs').val(), responsavel:usuarioFull};
            await fetch(URL_API, {method:'POST', mode:'no-cors', body:JSON.stringify(dados)});
            bootstrap.Modal.getInstance(document.getElementById('modalNovoPedido')).hide();
            carregarPedidos();
        }

        async function excluirPedido(id) { if(!confirm("Excluir?")) return; await fetch(URL_API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({acao: 'excluir_pedido', id: id}) }); carregarPedidos(); }
        function mudarPagina(d) { const total = Math.ceil(dadosFiltrados.length / itensPorPagina); if (paginaAtual + d >= 1 && paginaAtual + d <= total) { paginaAtual += d; renderizarTabela(); } }
        function atualizarContadores(lista) { $('#totalPedidos').text(lista.length); $('#totalAnalise').text(lista.filter(p=>p[6]==='EM AN√ÅLISE').length); $('#totalAtendidos').text(lista.filter(p=>p[6]==='ATENDIDO').length); $('#totalNaoEnc').text(lista.filter(p=>p[6]==='N√ÉO ENCONTRADO').length); }
        function filtrarPorCard(s) { $('#filtroStatus').val(s); aplicarFiltros(); }
        window.onload = carregarPedidos;
    </script>
</body>
</html>
