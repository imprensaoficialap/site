<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - NIO INTERNO</title>

    <link rel="shortcut icon" href="img/favicon1.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/estilo.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

    <style>
        .navbar-top-modern { background-color: var(--azul); padding: 10px 20px; }
        .nav-link-custom {
            color: rgba(255,255,255,0.7) !important;
            font-weight: 600;
            padding: 8px 18px !important;
            border-radius: 8px;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        .nav-link-custom:hover { color: white !important; background: rgba(255,255,255,0.1); }
        .nav-link-custom.active { color: white !important; background: rgba(255,255,255,0.2); box-shadow: inset 0 -2px 0 #ffc107; }

        .card-resumo {
            position: relative;
            padding: 25px 20px;
            border-radius: 15px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            overflow: hidden;
            border: none;
            transition: transform 0.3s ease;
            cursor: pointer;
            min-height: 135px;
        }
        .card-resumo:hover { transform: translateY(-5px); }

        .kpi-label {
            display: block;
            text-transform: uppercase;
            font-size: 0.75rem;
            font-weight: 800;
            letter-spacing: 1px;
            margin-bottom: 5px;
            opacity: 0.9;
        }
        .kpi-value { font-size: 3.2rem; font-weight: 900; margin: 0; line-height: 1; }
        .kpi-icon {
            font-size: 4rem;
            position: absolute;
            right: -10px;
            bottom: -15px;
            opacity: 0.2;
            transform: rotate(-15deg);
        }

        .bg-pendente { background: linear-gradient(45deg, #f1b44c, #f19f00); }
        .bg-atendido { background: linear-gradient(45deg, #34c38f, #2ca073); }
        .bg-nao-encontrado { background: linear-gradient(45deg, #f46a6a, #d64545); }
        .bg-total { background: linear-gradient(45deg, #556ee6, #3b5de7); }

        @media (min-width: 993px) {
            .navbar-menu-center { position: absolute; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        }
        @media (max-width: 992px) {
            .navbar-menu-center {
                display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 15px 0;
                width: 100%; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;
            }
            .navbar-container { flex-wrap: wrap; }
            .table thead { display: none; }
            .table tr { display: block; margin-bottom: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee; }
            .table td { display: flex; justify-content: space-between; align-items: center; text-align: right; border-bottom: 1px solid #f0f0f0; padding: 10px 15px; }
            .table td::before { content: attr(data-label); font-weight: bold; color: #666; text-transform: uppercase; font-size: 0.75rem; text-align: left; }
            .table td:last-child { border-bottom: none; text-align: center; justify-content: flex-end; }
        }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark shadow-sm sticky-top navbar-top-modern">
    <div class="container-fluid navbar-container">
        <span class="navbar-brand fw-bold fs-4">
            <i class="bi bi-shield-lock-fill me-2 text-warning"></i>NIO <span class="fw-light opacity-75">INTERNO</span>
        </span>

        <div class="navbar-menu-center">
            <a class="nav-link-custom active" href="painel.html"><i class="bi bi-list-task"></i> Pedidos</a>
            <a class="nav-link-custom" href="referencias.html"><i class="bi bi-book"></i> Refer√™ncias</a>
            <a class="nav-link-custom" href="relatorios.html"><i class="bi bi-graph-up-arrow"></i> Relat√≥rios</a>
        </div>

        <div class="d-flex align-items-center text-white mt-lg-0 mt-2">
            <span class="me-3 d-none d-sm-inline opacity-75 small">Ol√°, <strong id="nomeUsuario">...</strong></span>
            <button onclick="sair()" class="btn btn-sm btn-outline-light rounded-pill px-3 fw-bold">
                SAIR <i class="bi bi-box-arrow-right ms-1"></i>
            </button>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4 px-lg-5">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h2 class="fw-bold text-dark m-0">Gest√£o de Pedidos</h2>
            <small class="text-muted" id="statusAuto"><i class="bi bi-circle-fill text-success small me-1"></i> Atualiza√ß√£o autom√°tica ativa</small>
        </div>
        <button class="btn btn-success fw-bold shadow-sm px-4 py-2 rounded-3" onclick="abrirModalNovo()">
            <i class="bi bi-plus-lg me-2"></i> NOVO PEDIDO
        </button>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card-resumo bg-pendente shadow-sm" onclick="filtrarPorCard('EM AN√ÅLISE')">
                <div>
                    <span class="kpi-label">Pendentes</span>
                    <h2 class="kpi-value" id="totalAnalise">0</h2>
                </div>
                <i class="bi bi-hourglass-split kpi-icon"></i>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card-resumo bg-atendido shadow-sm" onclick="filtrarPorCard('ATENDIDO')">
                <div>
                    <span class="kpi-label">Atendidos</span>
                    <h2 class="kpi-value" id="totalAtendidos">0</h2>
                </div>
                <i class="bi bi-check-circle-fill kpi-icon"></i>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card-resumo bg-nao-encontrado shadow-sm" onclick="filtrarPorCard('N√ÉO ENCONTRADO')">
                <div>
                    <span class="kpi-label">N√£o Enc.</span>
                    <h2 class="kpi-value" id="totalNaoEnc">0</h2>
                </div>
                <i class="bi bi-x-circle-fill kpi-icon"></i>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card-resumo bg-total shadow-sm" onclick="filtrarPorCard('TODOS')">
                <div>
                    <span class="kpi-label">Total Geral</span>
                    <h2 class="kpi-value" id="totalPedidos">0</h2>
                </div>
                <i class="bi bi-grid-fill kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4 rounded-3">
        <div class="card-body p-3">
            <div class="row g-2 align-items-center">
                <div class="col-12 col-md">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="inputPesquisa" class="form-control border-start-0 bg-light" placeholder="Buscar por nome, ano ou assunto..." onkeyup="aplicarFiltros()">
                    </div>
                </div>
                <div class="col-8 col-md-auto">
                    <select id="filtroStatus" class="form-select border-0 bg-light fw-bold" onchange="aplicarFiltros()">
                        <option value="EM AN√ÅLISE" selected>‚ö†Ô∏è MOSTRAR PENDENTES</option>
                        <option value="TODOS">üìã MOSTRAR TODOS</option>
                        <option value="ATENDIDO">‚úÖ ATENDIDOS</option>
                        <option value="N√ÉO ENCONTRADO">‚ùå N√ÉO ENC.</option>
                    </select>
                </div>
                <div class="col-4 col-md-auto">
                    <button onclick="carregarPedidos()" class="btn btn-primary w-100 fw-bold">
                        <i class="bi bi-arrow-clockwise me-1"></i> ATUALIZAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="containerLista" class="mb-5">
        <div class="table-responsive bg-white shadow-sm rounded-3">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light text-uppercase" style="font-size: 0.75rem; letter-spacing: 1px;">
                    <tr>
                        <th class="ps-4" style="width: 120px;">Data</th>
                        <th style="width: 18%;">Solicitante</th>
                        <th>O que pesquisar?</th>
                        <th>Per√≠odo</th>
                        <th>Contato</th>
                        <th>Status</th>
                        <th>Resp.</th>
                        <th class="text-end pe-4" style="width: 190px;">A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="tabelaPedidos">
                    <tr><td colspan="8" class="text-center p-5"><div class="spinner-border text-primary"></div><br>Carregando dados...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <span class="text-muted small">Mostrando p√°gina <span id="paginaAtual" class="fw-bold text-primary">1</span></span>
            <div class="btn-group shadow-sm">
                <button class="btn btn-white btn-sm border" onclick="mudarPagina(-1)"><i class="bi bi-chevron-left"></i> Anterior</button>
                <button class="btn btn-white btn-sm border" onclick="mudarPagina(1)">Pr√≥xima <i class="bi bi-chevron-right"></i></button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAtendimento" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title fw-bold">Finalizar Atendimento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="editId">
                <div class="mb-3">
                    <label class="fw-bold small text-muted mb-2">STATUS:</label>
                    <select id="editStatus" class="form-select form-select-lg fw-bold">
                        <option value="ATENDIDO">‚úÖ PEDIDO ATENDIDO</option>
                        <option value="N√ÉO ENCONTRADO">‚ùå N√ÉO ENCONTRADO</option>
                        <option value="EM AN√ÅLISE">‚ö†Ô∏è DEVOLVER PARA AN√ÅLISE</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="fw-bold small text-muted mb-2">OBSERVA√á√ÉO DO T√âCNICO:</label>
                    <textarea id="editRetorno" class="form-control" rows="3" placeholder="Digite o resultado..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary px-5 fw-bold" onclick="salvarAlteracao()">Salvar Altera√ß√£o</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNovoPedido" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white border-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-plus-circle me-2"></i>Novo Registro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="formNovoPedido">
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">SOLICITANTE</label>
                        <input type="text" id="novoSolicitante" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">O QUE PESQUISAR?</label>
                        <input type="text" id="novoPesquisa" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="fw-bold small text-muted">PER√çODO</label>
                            <input type="text" id="novoPeriodo" class="form-control" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="fw-bold small text-muted">WHATSAPP</label>
                            <input type="text" id="novoZap" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-0">
                        <label class="fw-bold small text-muted">OBSERVA√á√ïES</label>
                        <textarea id="novoObs" class="form-control" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success px-5 fw-bold" onclick="salvarNovoPedido()">Cadastrar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const URL_API = 'https://script.google.com/macros/s/AKfycbw1YF42SazcEuLyI-I8g-btHyYlUJWC2jllDG7T59BgOL_lvmzuwQiqyW6-oJwM5-JV/exec';

    // ‚úÖ Sess√£o: 8 horas
    const SESSION_MAX_MS = 8 * 60 * 60 * 1000;

    function sessaoValida() {
        const token = localStorage.getItem('nio_token');
        const ts = parseInt(localStorage.getItem('nio_login_ts') || '0', 10);
        if (token !== 'logado') return false;
        if (!ts) return false;
        return (Date.now() - ts) <= SESSION_MAX_MS;
    }

    function sair() {
        localStorage.removeItem('nio_token');
        localStorage.removeItem('nio_usuario');
        localStorage.removeItem('nio_login_ts');
        window.location.href = 'login.html';
    }

    // ‚úÖ Prote√ß√£o (se expirou, manda pro login)
    if (!sessaoValida()) {
        sair();
    } else {
        // renova o "tempo" a cada p√°gina aberta (deslize simples de sess√£o)
        localStorage.setItem('nio_login_ts', String(Date.now()));
    }

    // ‚úÖ Nome no topo (primeiro nome + 1¬™ letra mai√∫scula)
    const usuarioFull = localStorage.getItem('nio_usuario') || "Servidor";
    const primeiroNomeRaw = (usuarioFull.split(' ')[0] || "Servidor").toLowerCase();
    const primeiroNomeFormatado = primeiroNomeRaw.charAt(0).toUpperCase() + primeiroNomeRaw.slice(1);
    document.getElementById('nomeUsuario').innerText = primeiroNomeFormatado;

    let dadosGlobais = [], dadosFiltrados = [], paginaAtual = 1;
    const itensPorPagina = 10;

    $(document).ready(function(){ $('#novoZap').mask('(00) 00000-0000'); });

    function copiarTexto(texto, btn) {
        navigator.clipboard.writeText(texto).then(() => {
            const htmlOrig = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check-lg"></i>';
            btn.classList.add('btn-success', 'text-white');
            setTimeout(() => {
                btn.innerHTML = htmlOrig;
                btn.classList.remove('btn-success', 'text-white');
            }, 1500);
        }).catch(() => alert('Erro ao copiar.'));
    }

    async function carregarPedidos() {
        const tbody = document.getElementById('tabelaPedidos');
        try {
            const response = await fetch(URL_API + '?acao=listar_pedidos');
            const data = await response.json();
            if (data.result === 'success' && Array.isArray(data.pedidos)) {
                dadosGlobais = data.pedidos.reverse();
                atualizarContadores(dadosGlobais);
                aplicarFiltros();
            }
        } catch (error) { console.error("Erro rede:", error); }
    }

    function aplicarFiltros() {
        const termo = document.getElementById('inputPesquisa').value.toLowerCase();
        const status = document.getElementById('filtroStatus').value;
        dadosFiltrados = dadosGlobais.filter(p => {
            const matchTexto = String(p[2]).toLowerCase().includes(termo) || String(p[3]).toLowerCase().includes(termo);
            const matchStatus = status === 'TODOS' || p[6] === status;
            return matchTexto && matchStatus;
        });
        paginaAtual = 1;
        renderizarTabela();
    }

    function renderizarTabela() {
        const tbody = document.getElementById('tabelaPedidos');
        tbody.innerHTML = '';
        if(dadosFiltrados.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center p-5 text-muted">Nenhum pedido encontrado.</td></tr>';
            return;
        }
        const inicio = (paginaAtual - 1) * itensPorPagina;
        const paginaDados = dadosFiltrados.slice(inicio, inicio + itensPorPagina);
        document.getElementById('paginaAtual').innerText = paginaAtual;

        paginaDados.forEach(p => {
            let badge = p[6] === 'ATENDIDO' ? 'bg-success' : (p[6] === 'N√ÉO ENCONTRADO' ? 'bg-danger' : 'bg-warning text-dark');
            let zap = p[5] ? `https://wa.me/55${p[5].replace(/\D/g,'')}` : '#';

            tbody.innerHTML += `<tr>
                <td data-label="Data" class="ps-4 text-muted small">${p[1]}</td>
                <td data-label="Solicitante" class="fw-bold text-primary">${p[2]}</td>
                <td data-label="Pesquisa">
                    <div class="d-flex align-items-start justify-content-between bg-light p-2 rounded small">
                        <span class="text-wrap">${p[3]}</span>
                        <button class="btn btn-sm text-secondary p-0 ms-2" onclick="copiarTexto('${p[3]}', this)"><i class="bi bi-clipboard"></i></button>
                    </div>
                </td>
                <td data-label="Per√≠odo">${p[4]}</td>
                <td data-label="Contato"><a href="${zap}" target="_blank" class="btn btn-outline-success btn-sm rounded-circle"><i class="bi bi-whatsapp"></i></a></td>
                <td data-label="Status"><span class="badge ${badge} rounded-pill">${p[6]}</span></td>
                <td data-label="Resp."><small class="text-secondary">${p[7] || '-'}</small></td>
                <td data-label="A√ß√£o" class="text-end pe-4">
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" onclick="abrirModal('${p[0]}','${p[6]}')">Atender</button>
                        <button class="btn btn-outline-danger btn-sm rounded-pill px-3" onclick="excluirPedido('${p[0]}')" title="Excluir registro">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        });
    }

    function mudarPagina(d) {
        const total = Math.ceil(dadosFiltrados.length / itensPorPagina);
        if (paginaAtual + d >= 1 && paginaAtual + d <= total) { paginaAtual += d; renderizarTabela(); }
    }

    function atualizarContadores(lista) {
        document.getElementById('totalPedidos').innerText = lista.length;
        document.getElementById('totalAnalise').innerText = lista.filter(p => p[6] === 'EM AN√ÅLISE').length;
        document.getElementById('totalAtendidos').innerText = lista.filter(p => p[6] === 'ATENDIDO').length;
        document.getElementById('totalNaoEnc').innerText = lista.filter(p => p[6] === 'N√ÉO ENCONTRADO').length;
    }

    const modalAtend = new bootstrap.Modal(document.getElementById('modalAtendimento'));
    function abrirModal(id, st) {
        document.getElementById('editId').value = id;
        document.getElementById('editStatus').value = st;
        document.getElementById('editRetorno').value = '';
        modalAtend.show();
    }

    async function salvarAlteracao() {
        const dados = {
            acao:'atualizar_pedido',
            id:$('#editId').val(),
            status:$('#editStatus').val(),
            retorno:$('#editRetorno').val(),
            responsavel: (localStorage.getItem('nio_usuario') || "SISTEMA")
        };
        await fetch(URL_API, {method:'POST', mode:'no-cors', body:JSON.stringify(dados)});
        modalAtend.hide();
        carregarPedidos();
    }

    async function excluirPedido(id) {
        if(!confirm("Tem certeza que deseja excluir este registro?")) return;
        try {
            await fetch(URL_API, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ acao: 'excluir_pedido', id: id })
            });
            setTimeout(() => carregarPedidos(), 1200);
        } catch(e) {
            alert("Erro ao excluir.");
        }
    }

    const modalNovo = new bootstrap.Modal(document.getElementById('modalNovoPedido'));
    function abrirModalNovo() { document.getElementById('formNovoPedido').reset(); modalNovo.show(); }

    async function salvarNovoPedido() {
        const dados = {
            acao:'novo_pedido',
            solicitante:$('#novoSolicitante').val(),
            nome_pesquisado:$('#novoPesquisa').val(),
            periodo:$('#novoPeriodo').val(),
            whatsapp:$('#novoZap').val(),
            observacoes:$('#novoObs').val(),
            responsavel:(localStorage.getItem('nio_usuario') || "SISTEMA")
        };
        await fetch(URL_API, {method:'POST', mode:'no-cors', body:JSON.stringify(dados)});
        modalNovo.hide();
        carregarPedidos();
    }

    function filtrarPorCard(s) { document.getElementById('filtroStatus').value = s; aplicarFiltros(); }
    window.onload = carregarPedidos;
</script>
</body>
</html>
