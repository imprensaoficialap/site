<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - NIO INTERNO</title>
    
    <link rel="shortcut icon" href="img/favicon1.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/estilo.css">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
</head>
<body class="bg-light">

    <!-- NAVBAR MODERNA -->
    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm sticky-top" style="background-color: var(--azul);">
        <div class="container-fluid px-lg-5">
            <span class="navbar-brand fw-bold fs-4">
                <i class="bi bi-shield-lock-fill me-2 text-warning"></i>NIO <span class="fw-light opacity-75">INTERNO</span>
            </span>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav gap-2">
                    <li class="nav-item">
                        <a class="nav-link-custom active" href="painel.html"><i class="bi bi-list-task me-2"></i>Pedidos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-custom" href="referencias.html"><i class="bi bi-book me-2"></i>Refer√™ncias</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-custom" href="relatorios.html"><i class="bi bi-graph-up-arrow me-2"></i>Relat√≥rios</a>
                    </li>
                </ul>
            </div>

            <div class="d-flex align-items-center text-white mt-3 mt-lg-0">
                <span class="me-3 d-none d-sm-inline opacity-75 small">Ol√°, <strong id="nomeUsuario">Servidor</strong></span>
                <button onclick="sair()" class="btn btn-sm btn-outline-light rounded-pill px-3 fw-bold">
                    SAIR <i class="bi bi-box-arrow-right ms-1"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4 px-lg-5">
        
        <!-- CABE√áALHO DE T√çTULO -->
        <div class="d-flex justify-content-between align-items-end mb-4">
            <div>
                <h2 class="fw-bold text-dark m-0">Gest√£o de Pedidos</h2>
                <small class="text-muted"><i class="bi bi-circle-fill text-success small me-1"></i> Atualiza√ß√£o autom√°tica ativa</small>
            </div>
            <button class="btn btn-success fw-bold shadow-sm px-4 py-2 rounded-3" onclick="abrirModalNovo()">
                <i class="bi bi-plus-lg me-2"></i> NOVO PEDIDO
            </button>
        </div>

        <!-- CARDS KPI (DEGRAD√ä E DESTAQUE) -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card-resumo bg-pendente shadow-sm" onclick="filtrarPorCard('EM AN√ÅLISE')">
                    <div class="kpi-content">
                        <span class="kpi-label">Pendentes</span>
                        <h2 class="kpi-value" id="totalAnalise">0</h2>
                    </div>
                    <i class="bi bi-hourglass-split kpi-icon"></i>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card-resumo bg-atendido shadow-sm" onclick="filtrarPorCard('ATENDIDO')">
                    <div class="kpi-content">
                        <span class="kpi-label">Atendidos</span>
                        <h2 class="kpi-value" id="totalAtendidos">0</h2>
                    </div>
                    <i class="bi bi-check-circle-fill kpi-icon"></i>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card-resumo bg-nao-encontrado shadow-sm" onclick="filtrarPorCard('N√ÉO ENCONTRADO')">
                    <div class="kpi-content">
                        <span class="kpi-label">N√£o Enc.</span>
                        <h2 class="kpi-value" id="totalNaoEnc">0</h2>
                    </div>
                    <i class="bi bi-x-circle-fill kpi-icon"></i>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card-resumo bg-total shadow-sm" onclick="filtrarPorCard('TODOS')">
                    <div class="kpi-content">
                        <span class="kpi-label">Total Geral</span>
                        <h2 class="kpi-value" id="totalPedidos">0</h2>
                    </div>
                    <i class="bi bi-grid-fill kpi-icon"></i>
                </div>
            </div>
        </div>

        <!-- BARRA DE FILTROS -->
        <div class="card shadow-sm border-0 mb-4 rounded-3">
            <div class="card-body p-3">
                <div class="row g-2 align-items-center">
                    <div class="col-12 col-md">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                            <input type="text" id="inputPesquisa" class="form-control border-start-0 bg-light" placeholder="Buscar por nome, ano ou assunto..." onkeyup="aplicarFiltros()">
                        </div>
                    </div>
                    <div class="col-8 col-md-auto">
                        <select id="filtroStatus" class="form-select border-0 bg-light fw-bold" onchange="aplicarFiltros()">
                            <option value="EM AN√ÅLISE" selected>‚ö†Ô∏è MOSTRAR PENDENTES</option>
                            <option value="TODOS">üìã MOSTRAR TODOS</option>
                            <option value="ATENDIDO">‚úÖ ATENDIDOS</option>
                            <option value="N√ÉO ENCONTRADO">‚ùå N√ÉO ENC.</option>
                        </select>
                    </div>
                    <div class="col-4 col-md-auto">
                        <button onclick="carregarPedidos()" class="btn btn-primary w-100 fw-bold">
                            <i class="bi bi-arrow-clockwise me-1"></i> ATUALIZAR
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABELA DE DADOS -->
        <div id="containerLista" class="mb-5">
            <div class="table-responsive bg-white shadow-sm rounded-3">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light text-uppercase" style="font-size: 0.75rem; letter-spacing: 1px;">
                        <tr>
                            <th class="ps-4" style="width: 120px;">Data</th>
                            <th style="width: 18%;">Solicitante</th>
                            <th>O que pesquisar?</th>
                            <th>Per√≠odo</th>
                            <th>Contato</th>
                            <th>Status</th>
                            <th>Resp.</th>
                            <th class="text-end pe-4" style="width: 160px;">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaPedidos">
                        <tr><td colspan="8" class="text-center p-5"><div class="spinner-border text-primary"></div><br>Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- PAGINA√á√ÉO -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <span class="text-muted small">Mostrando p√°gina <span id="paginaAtual" class="fw-bold text-primary">1</span></span>
                <div class="btn-group shadow-sm">
                    <button class="btn btn-white btn-sm border" onclick="mudarPagina(-1)"><i class="bi bi-chevron-left"></i> Anterior</button>
                    <button class="btn btn-white btn-sm border" onclick="mudarPagina(1)">Pr√≥xima <i class="bi bi-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ATENDIMENTO -->
    <div class="modal fade" id="modalAtendimento" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold">Finalizar Atendimento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="editId">
                    <div class="mb-3">
                        <label class="fw-bold small text-muted mb-2">ALTERAR STATUS PARA:</label>
                        <select id="editStatus" class="form-select form-select-lg fw-bold">
                            <option value="ATENDIDO">‚úÖ PEDIDO ATENDIDO</option>
                            <option value="N√ÉO ENCONTRADO">‚ùå N√ÉO ENCONTRADO</option>
                            <option value="EM AN√ÅLISE">‚ö†Ô∏è DEVOLVER PARA AN√ÅLISE</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold small text-muted mb-2">OBSERVA√á√ÉO DO T√âCNICO:</label>
                        <textarea id="editRetorno" class="form-control" rows="3" placeholder="Digite o resultado da busca..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary px-5 fw-bold" onclick="salvarAlteracao()">Salvar Altera√ß√£o</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL NOVO PEDIDO -->
    <div class="modal fade" id="modalNovoPedido" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-success text-white border-0">
                    <h5 class="modal-title fw-bold"><i class="bi bi-plus-circle me-2"></i>Cadastrar Novo Pedido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formNovoPedido">
                        <div class="mb-3">
                            <label class="fw-bold small text-muted">NOME DO SOLICITANTE</label>
                            <input type="text" id="novoSolicitante" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold small text-muted">O QUE PESQUISAR?</label>
                            <input type="text" id="novoPesquisa" class="form-control" required placeholder="Ex: Decreto 123/1990">
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="fw-bold small text-muted">ANO/PER√çODO</label>
                                <input type="text" id="novoPeriodo" class="form-control" required placeholder="Ex: 1990-1995">
                            </div>
                            <div class="col-6 mb-3">
                                <label class="fw-bold small text-muted">WHATSAPP</label>
                                <input type="text" id="novoZap" class="form-control" required placeholder="(96) 00000-0000">
                            </div>
                        </div>
                        <div class="mb-0">
                            <label class="fw-bold small text-muted">OBSERVA√á√ïES INTERNAS</label>
                            <textarea id="novoObs" class="form-control" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success px-5 fw-bold" onclick="salvarNovoPedido()">Cadastrar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const URL_API = 'https://script.google.com/macros/s/AKfycbwyUU8r73JdZJdhmF81h_D-Rr5DHo98TDQkgW3zl31y8RYnHjxsXla6wfSyfhT--DLNJ/exec';
        let dadosGlobais = [], dadosFiltrados = [], paginaAtual = 1;
        const itensPorPagina = 10;

        const usuarioLogado = localStorage.getItem('nio_usuario');
        if (!usuarioLogado) window.location.href = 'login.html';
        document.getElementById('nomeUsuario').innerText = usuarioLogado.split(' ')[0];
        
        function sair() { localStorage.clear(); window.location.href = 'login.html'; }
        
        $(document).ready(function(){ $('#novoZap').mask('(00) 00000-0000'); });

        function copiarTexto(texto, btn) {
            navigator.clipboard.writeText(texto).then(() => {
                const htmlOrig = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check-lg"></i>';
                btn.classList.add('btn-success', 'text-white');
                setTimeout(() => {
                    btn.innerHTML = htmlOrig;
                    btn.classList.remove('btn-success', 'text-white');
                }, 1500);
            }).catch(() => alert('Erro ao copiar.'));
        }

        async function carregarPedidos() {
            const tbody = document.getElementById('tabelaPedidos');
            const statusDiv = document.getElementById('statusAuto');
            
            const cacheLocal = localStorage.getItem('nio_pedidos_cache');
            let carregouCache = false;

            if (cacheLocal) {
                try {
                    const dadosCache = JSON.parse(cacheLocal);
                    if(Array.isArray(dadosCache) && dadosCache.length > 0) {
                        dadosGlobais = dadosCache;
                        atualizarContadores(dadosGlobais);
                        aplicarFiltros();
                        carregouCache = true;
                    }
                } catch (e) { localStorage.removeItem('nio_pedidos_cache'); }
            }

            if (!carregouCache) tbody.innerHTML = '<tr><td colspan="8" class="text-center p-5"><div class="spinner-border text-primary"></div><br>Buscando dados...</td></tr>';
            
            try {
                const response = await fetch(URL_API + '?acao=listar_pedidos');
                const data = await response.json();
                
                if (data.result === 'success' && Array.isArray(data.pedidos)) {
                    const pedidosOrdenados = data.pedidos.reverse(); 
                    const dadosNovosString = JSON.stringify(pedidosOrdenados);
                    
                    if (dadosNovosString !== cacheLocal) {
                        dadosGlobais = pedidosOrdenados;
                        localStorage.setItem('nio_pedidos_cache', dadosNovosString);
                        atualizarContadores(dadosGlobais);
                        aplicarFiltros();
                    }
                }
            } catch (error) {
                console.error("Erro rede:", error);
            }
        }

        function filtrarPorCard(status) { document.getElementById('filtroStatus').value = status; aplicarFiltros(); }

        function aplicarFiltros() {
            const termo = document.getElementById('inputPesquisa').value.toLowerCase();
            const status = document.getElementById('filtroStatus').value;
            dadosFiltrados = dadosGlobais.filter(p => {
                const matchTexto = String(p[2]).toLowerCase().includes(termo) || String(p[3]).toLowerCase().includes(termo) || String(p[4]).includes(termo);
                const matchStatus = status === 'TODOS' || p[6] === status;
                return matchTexto && matchStatus;
            });
            paginaAtual = 1;
            renderizarTabela();
        }

        function renderizarTabela() {
            const tbody = document.getElementById('tabelaPedidos');
            tbody.innerHTML = '';
            
            if(dadosFiltrados.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted p-5 fs-5">Nenhum pedido encontrado.</td></tr>'; return; }

            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const paginaDados = dadosFiltrados.slice(inicio, fim);
            document.getElementById('paginaAtual').innerText = paginaAtual;

            paginaDados.forEach(p => {
                let badgeClass = 'bg-secondary';
                if(p[6] === 'EM AN√ÅLISE') badgeClass = 'bg-warning text-dark';
                else if(p[6] === 'ATENDIDO') badgeClass = 'bg-success';
                else if(p[6] === 'N√ÉO ENCONTRADO') badgeClass = 'bg-danger';

                let zap = p[5] ? `https://wa.me/55${p[5].toString().replace(/\D/g,'')}` : '#';
                let textoPesquisa = p[3] || "";
                let textoSafe = textoPesquisa.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                tbody.innerHTML += `<tr>
                    <td data-label="Data" class="ps-4 text-muted small">${p[1]}</td>
                    <td data-label="Solicitante" class="fw-bold text-primary">${p[2]}</td>
                    <td data-label="Pesquisa">
                        <div class="d-flex align-items-start justify-content-between bg-light p-2 rounded">
                            <span class="text-wrap me-2" style="font-size: 0.9rem;">${textoPesquisa}</span>
                            <button class="btn btn-sm text-secondary p-0" onclick="copiarTexto('${textoSafe}', this)"><i class="bi bi-clipboard"></i></button>
                        </div>
                    </td>
                    <td data-label="Per√≠odo">${p[4]}</td>
                    <td data-label="Contato"><a href="${zap}" target="_blank" class="btn btn-outline-success btn-sm rounded-circle"><i class="bi bi-whatsapp"></i></a></td>
                    <td data-label="Status"><span class="badge ${badgeClass} rounded-pill">${p[6]}</span></td>
                    <td data-label="Resp."><small class="text-secondary">${p[7]}</small></td>
                    <td data-label="A√ß√£o" class="text-end pe-4">
                        <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" onclick="abrirModal('${p[0]}','${p[6]}')">Atender</button>
                    </td>
                </tr>`;
            });
        }

        function mudarPagina(d) {
            const total = Math.ceil(dadosFiltrados.length / itensPorPagina);
            const nova = paginaAtual + d;
            if (nova >= 1 && nova <= total) { paginaAtual = nova; renderizarTabela(); window.scrollTo(0,0); }
        }

        function atualizarContadores(lista) {
            document.getElementById('totalPedidos').innerText = lista.length;
            document.getElementById('totalAnalise').innerText = lista.filter(p => p[6] === 'EM AN√ÅLISE').length;
            document.getElementById('totalAtendidos').innerText = lista.filter(p => p[6] === 'ATENDIDO').length;
            document.getElementById('totalNaoEnc').innerText = lista.filter(p => p[6] === 'N√ÉO ENCONTRADO').length;
        }

        const modalAtendimento = new bootstrap.Modal(document.getElementById('modalAtendimento'));
        function abrirModal(id, st) { document.getElementById('editId').value = id; document.getElementById('editStatus').value = st; document.getElementById('editRetorno').value = ''; modalAtendimento.show(); }

        async function salvarAlteracao() {
            const id = document.getElementById('editId').value, st = document.getElementById('editStatus').value, ret = document.getElementById('editRetorno').value, resp = localStorage.getItem('nio_usuario');
            const btn = document.querySelector('#modalAtendimento .btn-primary'), txtOrig = btn.innerText;
            btn.innerText = 'Salvando...'; btn.disabled = true;
            try { await fetch(URL_API, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({acao: 'atualizar_pedido', id: id, status: st, retorno: ret, responsavel: resp}) }); alert('Atualizado!'); modalAtendimento.hide(); carregarPedidos(); } catch(e) { alert('Erro.'); } finally { btn.innerText = txtOrig; btn.disabled = false; }
        }

        const modalNovo = new bootstrap.Modal(document.getElementById('modalNovoPedido'));
        function abrirModalNovo() { document.getElementById('formNovoPedido').reset(); modalNovo.show(); }

        async function salvarNovoPedido() {
            const form = { acao: 'novo_pedido', solicitante: document.getElementById('novoSolicitante').value, nome_pesquisado: document.getElementById('novoPesquisa').value, periodo: document.getElementById('novoPeriodo').value, whatsapp: document.getElementById('novoZap').value, observacoes: document.getElementById('novoObs').value, responsavel: localStorage.getItem('nio_usuario') };
            if(!form.solicitante) return alert('Preencha os campos.');
            const btn = document.querySelector('#modalNovoPedido .btn-success'), txtOrig = btn.innerText;
            btn.innerText = 'Enviando...'; btn.disabled = true;
            try { await fetch(URL_API, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(form) }); alert('Cadastrado!'); modalNovo.hide(); carregarPedidos(); } catch(e) { alert('Erro.'); } finally { btn.innerText = txtOrig; btn.disabled = false; }
        }

        window.onload = function() { carregarPedidos(); setInterval(() => carregarPedidos(), 60000); };
    </script>
</body>
</html>